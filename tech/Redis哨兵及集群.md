# Redis哨兵及集群

## 为什么需要哨兵？

> 实现了redis数据节点监控、故障发现转移、配置中心、客户端通知，从而保证了服务的高可用

## 主节点宕机的处理方式（人工运维）

1. 人工/服务发现主节点宕机

1. 选取一个从节点提升为主节点

1. 将其他从节点变更主节点信息

1. 重启客户端

哨兵将这个流程变为自动化

## 哨兵是什么

> 哨兵也是普通的Redis节点，但不用于数据的存储，启动方式同数据节点类似

## 哨兵监控

1. ping主、从节点、其他sentinel节点
   1. 频次：1s
   2. 目的：探活、用于主观下线

1. 推送当前sentinel节点认为的主节点信息及sentinel自身信息，订阅主节点的_sentinel_:hello频道信息
   1. 频次：2s
   2. 目的：
      1. sentinel节点同步主节点信息，用于后续的客观下线和领导者选举
      2. 发现新的sentinel节点，用户sentinel节点间的信息同步

1. 向主节点发送info命令 查看节点信息和拓扑结构
   1. 频次：10s
   2. 目的：
      1. 通过主节点发现从节点，也就是为啥sentinel启动时只需配置主节点信息
      2. 节点不可达或者故障转移后，通过此命令更新拓扑结构

## 哨兵故障转移

## 处理流程：

1. ping命令 发现主节点不可达，单个sentinel节点做**主观下线**（可能存在误判）

1. 向其他sentinel节点发送sentinel is-master-down-by-addr询问对主节点的判断

1. 如果数量超过quorum个数，该sentinel节点对主节点做**客观下线**

1. 选取领导者节点

1. 故障转移（参见第一节），从节点的选择策略如下
   1. 过滤（主观下线、无响应）等不健康状态的从节点
   2. 选择slave-priority优先级最大的>复制偏移量最大的>runid最小的 


##  哨兵领导选举:（raft算法）

可参见：https://raft.github.io/

## 客户端通知

## 问答

### 1. sentinel节点没有达到quorum怎么办？

比如一共5个sentinel节点，客观下线的节点要求数quorm=6，此时不满足客观下线数量。

解决方案：1. 增加sentinel节点 2. 修改qauorm的设置（一般为 总结点数/2+1 ）

### 2.  从节点宕机怎么办？（如何保障从节点的高可用）

sentinel节点只对从节点进行主观下线，并没有后续动作。

解决方案：在sentinel主观下线推送的频道信息中，利用sentinel掌握所有节点的拓扑图，形成一个从节点的资源池，监听到从节点不可用，直接从资源池中进行剔除
