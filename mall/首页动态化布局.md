# 首页动态化布局

导读：每日优鲜作为整个生鲜互联网TOP APP之一，致力于让每个家庭买得省心,吃得放心，我们运用创新技术和业务模式，旨在推动中国社区零售行业数字化转型。首页作为优鲜的门面，是主要的流量入口和服务消费者的核心阵地，同时负责整个优鲜生态的业务分发和商业策略输出。其业务的复杂性之高、系统的稳定性之重都有着极高的要求。首页也从商品聚合展示的导购模式升级为个性化推荐的导购产品，从传统的千人一面到千仓千面，目前向着未来的一人千面发起冲锋号角。目前优鲜着力于提升首页转化分发效率，提升整体收益。

![img](http://img.javalemon.com/typora/(null))

## 背景

首页是主要的流量入口，分发效率一直是我们追求和决的核心问题。如何让最优的商品和资源内容高效的触达消费者侧，提升流量价值，一直是我们追求的目标之一，截止当前我们进行了不同方式的探索，实现和积累了一些策略来解决这个问题。

![home2](http://img.javalemon.com/typora/(null)-20220616231643350.(null))

当前首页根据不同的地域、人群划分出“极速版”、“全国版”、“多业态版”、“新人版”的业务版本，这些版本即传承手淘首页的通用能力，同时通过自身运营的自由度和独立体系，展示自己的垂直区域特色内容，更加高效的触达自身服务范围的用户

比如“极速版”是针对前置仓覆盖地区的页面投放，“全国版”则是打造一站式购齐，实现全品类覆盖的重要抓手。“多业态版”则是科学化布局的重要组成部分，“新人版”针对用户进行业务模块的精准分发达到促转化的目的。

## 新的挑战

随着首页整体业务策略的不断调整以及技术栈的不断升级，我们尝试基于人群、地域等属性进行的细粒度的人货匹配的运营策略，产生大量的分发效率实验需求，因App的发版限制，流量分发实验（比如资源位置之间的顺序调整），需要经过传统模式的生命周期，研发上线2周+数据收集2周，一次分发实验的时间成本约为1个月，大型流量分发实验甚至长达2个月。

传统模式

![img](http://img.javalemon.com/typora/(null)-20220616231655935.(null))

如何在需求爆炸式增长的同时进行快速响应，支撑运营流量的闭环验证，需要我们技术侧提供一套高效稳定的动态化策略方案。

## 破局

### 3.1 页面布局抽象

将首页的展示形态进行布局抽象，分别抽象出Page（模板）、Container（容器）、Item（资源组件）共同组成首页布局，page为多个container聚合而成，container则由资源item和边距样式构成，资源组件为容器内的填充内容，边距则是决定了容器与容器之间的间距。

首页布局的抽象形成了页面骨架模型（模板），根据页面模板进行组件数据的组装实现和排序，通过对模板的差异化管理解决了分版本、地域、人群的差异化呈现，将原来需要发版解决的模块布局问题（比如container的上移、下移、替换）通过下发数据的变更来实现，为实现动态化布局提供了支撑，后端则专注于单体资源组件的逻辑研发。

![img](http://img.javalemon.com/typora/(null)-20220616231702897.(null))

### 3.2 端侧协议抽象

在我们体系建设之前端侧协议还是面向版本的单向协议，前后端的耦合度十分高，改动周期按月计算，迭代成本巨大。首页的组件渲染是典型的 MVVM 的模式，端侧( View )和服务数据( Model )通过组件化协议( ViewModel )进行双向通信，通过抽象组件协议解耦两端的耦合性问题，组件协议本身的抽象和定义是我们首先需要去面对的问题，设计过于复杂、抽象过于碎片会使协议难于维护前后端联调沟通成本放大，设计的过于精简、抽象过于宽泛又起不到解耦的效果。

在tangram建设的过程中，我们探讨过两种组件模型：

1. 基于前端app展示形态决定组件类型
   1. 陈列规则：单双排
   2. 渲染效果：轮播、滚动

分析：扩展性较好，但组件兼容及组件升级处理较为复杂、维护成本高

1. 基于后端资源类型决定组件类型
   1. banner、活动大促位、icon位等

分析：组件升级简单、数据清晰；展示形态变更需发版

最终采用的为基于后端资源类型，决定使用此方案的原因主要为app展示形态方案抽象难度较高、维护成本高，基于后端资源类型易于维护、版本升级处理难度低、同类资源扩展性高。

![img](http://img.javalemon.com/typora/(null)-20220616231720565.(null))

### 3.3 组件可视化编排

组件编排流程：

1. 根据版本、地区、配送方式等规则匹配出满足展示的资源池
2. 使用穿梭功能，将组件预选入右侧模板栏
3. 在右侧模板栏中进行拖动排序，排列出最终需要的顺序

如下图所示：

![img](http://img.javalemon.com/typora/(null)-20220616231729708.(null))

### 3.4 组件实现分离

![img](http://img.javalemon.com/typora/(null)-20220616231736109.(null))

组件实现分离的目的：

1. 配置化管理：将原散落在业务逻辑中的资源，通过后管可视化的列表页面进行统一管理
2. 动态插拔：对于组件的管理实现了动态扩展，配置即生效
3. 分离实现逻辑：通过配置信息寻找实现类，并完成资源的填充

设计的亮点：

1. 使用模板设计模式，抽象了资源服务接入标准，新扩充资源统一范式接入，降低接入难度。
2. 同类资源进行了归并解析，并行调用，提升处理速度和性能

### 3.5 动态化和实时性

**动态化**：动态化模板，通过组件的组合+规则配置两个维度形成了几十种首页模板，这个模板池是动态化的基石，通过C端用户特征进行解析，寻找最匹配的模板进行呈现。

![img](http://img.javalemon.com/typora/(null)-20220616231741220.(null))

**实时性**：解析引擎、规则匹配实时生效

在匹配模板的处理上，定义了规则接口（Rule）、插槽接口（Slot）、链接口（Chain），规则接口定义了多个规则的信息，目前支持了8种规则可横向扩展规则；插槽接口抽象了规则的多个规则的匹配方式比如范围校验、匹配校验、互斥校验等；同时使用了责任链的设计模式，将多个插槽组合形成单向链表，进行业务模板的匹配；整体达到了解耦逻辑、增强扩展性的目的。 

![img](http://img.javalemon.com/typora/(null)-20220616231746837.(null))



### 3.6 数据安全

**发布流程保障稳定**

编辑草稿数据、发布线上数据，通过数据的隔离做到信息快照的保存及数据的稳定。

发布流程中引入白名单配置预览，减少运营人员的误配置对线上服务的影响。

![img](http://img.javalemon.com/typora/(null)-20220616231752841.(null))

**服务高可用设计**

1. tangram服务的高可用

风险1：配置问题 ，运营某一版本未覆盖

​         解决方案：采用双重兜底方案（兜底模板+配置兜底模板）

风险2：模板服务不可用（数据问题等）

解决方案：配置兜底组件，直接获取组件进行数据组装

1. 首页应用的高可用

风险1：tangram服务不可用

解决方案：回退到首页应用直接调用资源的方案，展示出兜底资源位

1. 进行监控上报，一旦发现模板服务出现问题，及时定位解决

## 达到的效果（收益）

### 4.1 架构全景图

从0到1完成了首页平台的建设，架构如下：

![img](http://img.javalemon.com/typora/(null)-20220616231759000.(null))

借助商城AS能力、棱镜AB平台、墨子搭建后管页面、资管等通用能力，建设新系统七巧板tangram，实现了页面搭建、分流实验配置、资源收拢管理、数据隔离、黑白名单等多项能力。以18个动态模板、13个资源组件、8种规则为动态基石，解析引擎、编排框架、分流规则为核心能力，同时对网页布局进行抽象，端侧协议升级，最终实现了动态实时生效，支持多端、跨平台、多业务能力。

### 4.2 交互流程图

![img](http://img.javalemon.com/typora/(null)-20220616231806117.(null))



### 4.3 动态实验&分发效率

将影响首页展示的因子都抽象为规则进行配置，通过动态ab实验信息配置，对照组和多组实验组进行数据转化对比，探索最佳转化，通过首页平台功能完成了3次流量分发实验，进行资源位调整决策两次，转化提升0.44%，实验的周期成本降低50%，将转化较低的资源位进行下线，集中运营力量进行高转化资源的运营和优化，达到降本提效的目的。

![img](http://img.javalemon.com/typora/(null)-20220616231815091.(null))

## 未来规划

![img](http://img.javalemon.com/typora/(null)-20220616231822263.(null))

1. 稳定性
   1. 加强审核中心建设，增加审核流程、操作快照、回滚机制，将配置人员的误操作造成的风险降到最低，同时提供快速回退能力。
2. 基础能力
   1. 增加数据看板功能：可以对模板及资源的转化效果直观的查看和分析
3. 平台化建设
   1. 提供能力API
   2. 通过端协议升级，DSL组件的管理下发，实现客户端模板管理
4. 赋能业务
   1. app核心布局实现动态化配置
   2. 零售云和菜场规划中
